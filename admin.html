<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>إدارة المنتجات</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <style>
      #loading-spinner {
        display: none;
        position: absolute;
        left: 50%;
        top: 50%;
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg" style="background-color: #fdb518">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">عودة</a>
      </div>
    </nav>
    <div id="loading-spinner">
      <div
        class="spinner-border text-warning"
        role="status"
        style="width: 4rem; height: 4rem"
      >
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <div class="container my-5" id="login-container">
      <h2 class="mb-4 text-center">تسجيل الدخول</h2>
      <form id="login-form" class="mb-4" style="max-width: 400px; margin: auto">
        <div class="mb-3">
          <label for="username" class="form-label">اسم المستخدم</label>
          <input type="text" class="form-control" id="username" required />
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">كلمة السر</label>
          <input type="password" class="form-control" id="password" required />
        </div>
        <button type="submit" class="btn btn-primary w-100">دخول</button>
        <div id="login-error" class="text-danger mt-2" style="display: none">
          بيانات الدخول خاطئة
        </div>
      </form>
    </div>
    <div class="container my-5" id="admin-container" style="display: none">
      <h2 class="mb-4 text-center">إدارة المنتجات</h2>
      <form id="product-form" class="mb-4">
        <div class="mb-3">
          <label for="productCategory" class="form-label">الصنف</label>
          <select class="form-select" id="productCategory" required>
            <option value=""></option>
            <option value="الشرقي">الشرقي</option>
            <option value="الغربي">الغربي</option>
            <option value="تورتات">تورتات</option>
            <option value="عصائر">عصائر</option>
            <option value="شكلاطة">شكلاطة</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="productName" class="form-label">اسم المنتج</label>
          <input type="text" class="form-control" id="productName" required />
        </div>
        <div class="mb-3">
          <label for="productDesc" class="form-label">وصف المنتج</label>
          <textarea class="form-control" id="productDesc"></textarea>
        </div>
        <div class="mb-3">
  <label for="productPriceRegular" class="form-label">سعر عادي</label>
  <input type="number" class="form-control" id="productPriceRegular" min="0" step="0.01" required />
</div>
<div class="mb-3">
  <label for="productPriceBulk" class="form-label">سعر جملة</label>
  <input type="number" class="form-control" id="productPriceBulk" min="0" step="0.01" required />
</div>
        </div>
        <div class="mb-3">
          <label for="productImgUpload" class="form-label">صورة المنتج</label>
          <input
            type="file"
            class="form-control"
            id="productImgUpload"
            accept="image/*"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary">إضافة المنتج</button>
        <button
          type="button"
          class="btn btn-secondary"
          id="cancelEditBtn"
          style="display: none"
        >
          إلغاء التعديل
        </button>
      </form>
      <div id="product-list" class="row row-cols-2 row-cols-md-3 g-4"></div>
      <div
        id="admin-error"
        class="text-danger mt-2"
        style="display: none"
      ></div>
    </div>
    <script>
      let products = [];
      let uploadedImgDataUrl = "";
      let editProductId = null;

      function showSpinner(show) {
        document.getElementById("loading-spinner").style.display = show
          ? "block"
          : "none";
      }

      async function fetchProducts(category = null) {
        showSpinner(true);
        try {
          let url = "/api/products";
          if (category) url += "?category=" + encodeURIComponent(category);
          const res = await fetch(url);
          products = res.ok ? await res.json() : [];
        } catch (e) {
          document.getElementById("admin-error").textContent =
            "خطأ في تحميل المنتجات.";
          document.getElementById("admin-error").style.display = "";
          products = [];
        }
        renderProducts();
        showSpinner(false);
      }

      function renderProducts() {
        const category =
          document.getElementById("productCategory").value || "الشرقي";
        const productList = document.getElementById("product-list");
        productList.innerHTML = "";
        products.forEach((product) => {
          const productCard = `
          <div class="col">
            <div class="card h-100 shadow-sm" style="max-width:180px; margin:auto;">
              <img src="${product.img}" class="card-img-top" alt="${
            product.name
          }" style="height:80px; object-fit:cover;">
              <div class="card-body p-2">
                <h6 class="card-title mb-1" style="font-size:0.95rem;">${
                  product.name
                }</h6>
                <p class="card-text" style="font-size:0.85rem;">${
                  product.desc || ""
                }</p>
                <p class="card-text text-primary" style="font-size:0.95rem;">${
                  product.price_regular ? product.price_regular + " د.ل" : ""
                }
                </p>
                <p class="card-text text-primary" style="font-size:0.95rem;">${
                  product.price_bulk ? product.price_bulk + " د.ل" : ""
                }
                </p>
                <button class="btn btn-danger btn-sm" onclick="deleteProduct('${
                  product._id
                }')">حذف</button>
                <button class="btn btn-warning btn-sm" onclick="startEditProduct('${
                  product._id
                }')">تعديل</button>
              </div>
            </div>
          </div>
        `;
          productList.innerHTML += productCard;
        });
      }

      window.deleteProduct = async function (id) {
        if (!confirm("هل تريد حذف المنتج؟")) return;
        showSpinner(true);
        const res = await fetch("/api/products/" + id, { method: "DELETE" });
        if (res.ok) {
          products = products.filter((p) => p._id !== id);
          renderProducts();
        } else {
          alert("خطأ أثناء الحذف.");
        }
        showSpinner(false);
      };

      window.startEditProduct = function (id) {
        const product = products.find((p) => p._id === id);
        if (!product) return;
        editProductId = id;
        document.getElementById("productName").value = product.name;
        document.getElementById("productDesc").value = product.desc;
        price_regular = parseFloat(document.getElementById('productPriceRegular').value);
        price_bulk = parseFloat(document.getElementById('productPriceBulk').value);
        document.getElementById("productCategory").value = product.category;
        uploadedImgDataUrl = product.img;
        document.getElementById("cancelEditBtn").style.display = "";
      };

      document
        .getElementById("cancelEditBtn")
        .addEventListener("click", function () {
          editProductId = null;
          document.getElementById("product-form").reset();
          uploadedImgDataUrl = "";
          this.style.display = "none";
        });

      document
        .getElementById("productCategory")
        .addEventListener("change", function () {
          fetchProducts(this.value);
        });

      document
        .getElementById("productImgUpload")
        .addEventListener("change", function (event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              uploadedImgDataUrl = e.target.result;
            };
            reader.readAsDataURL(file);
          } else {
            uploadedImgDataUrl = "";
          }
        });

      document
        .getElementById("product-form")
        .addEventListener("submit", async function (event) {
          event.preventDefault();
          const category = document.getElementById("productCategory").value;
          const name = document.getElementById("productName").value;
          const desc = document.getElementById("productDesc").value;
          const price_regular = parseFloat(document.getElementById('productPriceRegular').value);
          const price_bulk = parseFloat(document.getElementById('productPriceBulk').value);
          const img = uploadedImgDataUrl;

          if (!category || !name || !img) {
            alert("يرجى تعبئة جميع الحقول المطلوبة.");
            return;
          }

          const productData = { name, category, price_regular, price_bulk, img, desc };

          showSpinner(true);

          if (editProductId) {
            const res = await fetch("/api/products/" + editProductId, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(productData),
            });
            if (res.ok) {
              const i = products.findIndex((p) => p._id === editProductId);
              if (i >= 0) products[i] = { ...productData, _id: editProductId };
              renderProducts();
              editProductId = null;
              document.getElementById("cancelEditBtn").style.display = "none";
              this.reset();
              uploadedImgDataUrl = "";
            } else {
              alert("خطأ أثناء تعديل المنتج.");
            }
          } else {
            const res = await fetch("/api/products", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(productData),
            });
            if (res.ok) {
              const newProduct = await res.json();
              products.push({ ...productData, _id: newProduct.id });
              renderProducts();
              this.reset();
              uploadedImgDataUrl = "";
            } else {
              alert("خطأ أثناء إضافة المنتج.");
            }
          }
          showSpinner(false);
        });

      document
        .getElementById("login-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const username = document.getElementById("username").value;
          const password = document.getElementById("password").value;
          showSpinner(true);
          const res = await fetch("/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          showSpinner(false);
          if (res.ok) {
            document.getElementById("login-container").style.display = "none";
            document.getElementById("admin-container").style.display = "";
            fetchProducts();
          } else {
            document.getElementById("login-error").style.display = "";
          }
        });

      async function checkAuth() {
        const res = await fetch("/api/admin-check");
        if (res.ok) {
          document.getElementById("login-container").style.display = "none";
          document.getElementById("admin-container").style.display = "";
          fetchProducts();
        } else {
          document.getElementById("login-container").style.display = "";
          document.getElementById("admin-container").style.display = "none";
        }
      }
      checkAuth();
    </script>
  </body>
</html>
