<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>لوحة الإدارة - حلويات عبمبر الزروق</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <style>
      body {
        background: #faf5e5;
      }
      .card-img-top {
        height: 80px;
        object-fit: cover;
      }
      .admin-header {
        background-color: #fdb518;
      }
      #login-container,
      #admin-container {
        display: none;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg admin-header">
      <div class="container-fluid py-3 px-0">
        <a
          class="navbar-brand ms-auto font-size-lg d-flex align-items-center"
          href="index.html"
          style="text-align: right"
        >
          <span class="me-3 fs-3 fw-bold"
            >لوحة الإدارة - حلويات عبمبر الزروق</span
          >
          <img
            src="res/logo.jpg"
            alt="Logo"
            style="height: 60px; vertical-align: middle"
          />
        </a>
      </div>
    </nav>
    <div class="container mt-4">
      <!-- Login -->
      <div id="login-container">
        <div class="row justify-content-center">
          <div class="col-md-4">
            <h3 class="text-center mb-3">دخول المشرف</h3>
            <form onsubmit="return login(event)">
              <div class="mb-3">
                <label class="form-label">اسم المستخدم</label>
                <input class="form-control" id="user" required />
              </div>
              <div class="mb-3">
                <label class="form-label">كلمة المرور</label>
                <input
                  type="password"
                  class="form-control"
                  id="pass"
                  required
                />
              </div>
              <button class="btn btn-warning w-100">دخول</button>
            </form>
          </div>
        </div>
      </div>
      <!-- Admin Panel -->
      <div id="admin-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>إدارة المنتجات</h3>
          <button class="btn btn-outline-danger" onclick="logout()">
            خروج
          </button>
        </div>
        <!-- Add/Edit Form -->
        <form
          id="product-form"
          class="mb-4"
          onsubmit="return saveProduct(event)"
        >
          <input type="hidden" id="productId" />
          <div class="row g-2">
            <div class="col-md-2">
              <input
                class="form-control"
                id="productName"
                placeholder="اسم المنتج"
                required
              />
            </div>
            <div class="col-md-2">
              <input
                class="form-control"
                id="productCategory"
                placeholder="الصنف"
                required
              />
            </div>
            <div class="col-md-2">
              <input
                class="form-control"
                id="productPriceRegular"
                type="number"
                min="0"
                step="0.01"
                placeholder="سعر عادي"
                required
              />
            </div>
            <div class="col-md-2">
              <input
                class="form-control"
                id="productPriceBulk"
                type="number"
                min="0"
                step="0.01"
                placeholder="سعر جملة"
                required
              />
            </div>
            <div class="col-md-2">
              <input
                class="form-control"
                id="productImg"
                placeholder="رابط صورة"
                required
              />
            </div>
            <div class="col-md-2">
              <input
                class="form-control"
                id="productDesc"
                placeholder="الوصف"
              />
            </div>
            <div class="col-md-12 mt-2">
              <button class="btn btn-success" type="submit">حفظ</button>
              <button
                class="btn btn-secondary"
                type="button"
                onclick="clearForm()"
              >
                جديد
              </button>
            </div>
          </div>
        </form>
        <div id="products-list"></div>
      </div>
    </div>
    <footer class="text-center text-muted py-3">
      &copy; 2025 مهند الزروق &mdash;
      <a href="LICENSE" target="_blank">MIT License</a>
    </footer>
    <script>
      async function checkAuth() {
        const res = await fetch("/api/admin-check");
        if (res.ok) {
          document.getElementById("login-container").style.display = "none";
          document.getElementById("admin-container").style.display = "";
          fetchProducts();
        } else {
          document.getElementById("login-container").style.display = "";
          document.getElementById("admin-container").style.display = "none";
        }
      }
      async function login(e) {
        e.preventDefault();
        const username = document.getElementById("user").value;
        const password = document.getElementById("pass").value;
        const res = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
          credentials: "include",
        });
        if (res.ok) checkAuth();
        else alert("بيانات دخول خاطئة");
      }
      async function logout() {
        await fetch("/api/logout", { method: "POST", credentials: "include" });
        checkAuth();
      }
      async function fetchProducts() {
        const res = await fetch("/api/products");
        const products = await res.json();
        let html = `<div class="row row-cols-2 row-cols-md-4 g-2">`;
        for (const p of products) {
          html += `<div class="col">
          <div class="card h-100 shadow-sm">
            <img src="${p.img}" class="card-img-top" alt="${p.name}">
            <div class="card-body p-2">
              <h6>${p.name}</h6>
              <span class="badge bg-secondary">${p.category}</span>
              <div class="text-primary mt-1">عادي: ${
                p.price_regular
              } د.ل | جملة: ${p.price_bulk} د.ل</div>
              <div class="mb-1">${p.desc || ""}</div>
              <button class="btn btn-sm btn-outline-success" onclick='editProduct(${JSON.stringify(
                p
              )})'>تعديل</button>
              <button class="btn btn-sm btn-outline-danger" onclick='deleteProduct("${
                p._id
              }")'>حذف</button>
            </div>
          </div>
        </div>`;
        }
        html += "</div>";
        document.getElementById("products-list").innerHTML = html;
      }
      async function saveProduct(e) {
        e.preventDefault();
        const id = document.getElementById("productId").value;
        const name = document.getElementById("productName").value;
        const category = document.getElementById("productCategory").value;
        const price_regular = parseFloat(
          document.getElementById("productPriceRegular").value
        );
        const price_bulk = parseFloat(
          document.getElementById("productPriceBulk").value
        );
        const img = document.getElementById("productImg").value;
        const desc = document.getElementById("productDesc").value;
        const data = { name, category, price_regular, price_bulk, img, desc };
        let res;
        if (id) {
          res = await fetch("/api/products/" + id, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
            credentials: "include",
          });
        } else {
          res = await fetch("/api/products", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
            credentials: "include",
          });
        }
        if (res.ok) {
          fetchProducts();
          clearForm();
        } else {
          alert("فشل الحفظ");
        }
      }
      function editProduct(p) {
        document.getElementById("productId").value = p._id;
        document.getElementById("productName").value = p.name;
        document.getElementById("productCategory").value = p.category;
        document.getElementById("productPriceRegular").value = p.price_regular;
        document.getElementById("productPriceBulk").value = p.price_bulk;
        document.getElementById("productImg").value = p.img;
        document.getElementById("productDesc").value = p.desc || "";
      }
      function clearForm() {
        document.getElementById("productId").value = "";
        document.getElementById("productName").value = "";
        document.getElementById("productCategory").value = "";
        document.getElementById("productPriceRegular").value = "";
        document.getElementById("productPriceBulk").value = "";
        document.getElementById("productImg").value = "";
        document.getElementById("productDesc").value = "";
      }
      async function deleteProduct(id) {
        if (!confirm("تأكيد حذف المنتج؟")) return;
        const res = await fetch("/api/products/" + id, {
          method: "DELETE",
          credentials: "include",
        });
        if (res.ok) fetchProducts();
        else alert("فشل الحذف");
      }
      window.onload = checkAuth;
    </script>
  </body>
</html>
