<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>إدارة المنتجات | حلويات عبمبر الزروق</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      crossorigin="anonymous"
    />
    <style>
      body {
        background: #faf7f2;
        min-height: 100vh;
        direction: rtl;
        text-align: right;
      }
      .navbar-logo {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 2px solid #fffbe8;
        object-fit: cover;
        box-shadow: 0 2px 6px #0001;
        background: #fffbe8;
      }
      .fullscreen-card {
        max-width: 500px;
        margin: auto;
        border-radius: 20px;
        box-shadow: 0 4px 24px #0002;
        padding: 2rem 1rem 1.5rem 1rem;
        background: #fff;
      }
      .fade-in {
        animation: fadeIn 0.45s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .product-card {
        border-radius: 16px;
        box-shadow: 0 2px 10px #0002;
        padding: 0.5rem;
        margin-bottom: 1.2rem;
        background: #fff;
        max-width: 350px;
        margin-left: auto;
        margin-right: auto;
        transition: box-shadow 0.13s;
        min-height: 250px;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        text-align: right;
      }
      .product-card:hover {
        box-shadow: 0 4px 24px #0002;
      }
      .card-img-top {
        border-radius: 12px;
        height: 110px;
        object-fit: cover;
        margin-bottom: 0.5rem;
        cursor: zoom-in;
      }
      #drop-area {
        border: 2px dashed #aaa;
        padding: 1.5rem;
        text-align: center;
        background: #f9f9f9;
        border-radius: 1rem;
        margin: 1rem 0;
        transition: background 0.3s;
        cursor: pointer;
      }
      #drop-area.dragover {
        background: #ffe;
      }
      #preview-img {
        margin-top: 1rem;
        max-width: 160px;
        border-radius: 8px;
      }
      .toast-container {
        z-index: 2000;
      }
      .search-box {
        max-width: 350px;
        margin: 0 auto 1.3rem auto;
        text-align: right;
      }
      .form-label,
      .form-control,
      .form-select,
      .input-group-text {
        text-align: right;
        direction: rtl;
      }
      .card-title,
      .card-text {
        text-align: right;
      }
      .card-btn-row {
        display: flex;
        gap: 0.5rem;
      }
      @media (max-width: 600px) {
        .fullscreen-card {
          border-radius: 0 !important;
          box-shadow: none;
          padding: 1.2rem 0.2rem 1.2rem 0.2rem;
        }
        .navbar {
          padding: 0.5rem 0;
        }
        .product-card {
          max-width: 100%;
        }
      }
      .product-grid-container {
        max-width: 1300px;
        margin: 0 auto;
        padding: 0 8px;
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-light sticky-top shadow-sm"
      style="background-color: #fdb518; min-height: 70px; position: relative"
    >
      <div class="container-fluid justify-content-center">
        <a
          class="navbar-brand mx-auto d-flex flex-column align-items-center gap-2"
          href="index.html"
          style="text-decoration: none"
        >
          <img src="res/logo.jpg" alt="Logo" class="navbar-logo" />
          <span class="fs-4 fw-bold text-dark">لوحة إدارة المنتجات</span>
        </a>
        <button
          id="logout-btn"
          class="btn btn-danger logout-btn d-none d-md-block"
          style="font-size: 1rem; position: absolute; left: 16px; top: 14px"
        >
          <i class="bi bi-box-arrow-right"></i> خروج
        </button>
      </div>
    </nav>
    <div
      id="loading-spinner"
      style="
        display: none;
        position: fixed;
        left: 50%;
        top: 50%;
        z-index: 3000;
        transform: translate(-50%, -50%);
      "
    >
      <div
        class="spinner-border text-warning"
        role="status"
        style="width: 3rem; height: 3rem"
      >
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <div class="position-fixed bottom-0 end-0 p-3 toast-container">
      <div
        id="main-toast"
        class="toast align-items-center text-bg-primary border-0"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div class="toast-body" id="toast-body">تم الحفظ بنجاح!</div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
          ></button>
        </div>
      </div>
    </div>
    <div class="modal fade" id="img-modal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
          <img
            id="img-modal-img"
            class="w-100 rounded-3"
            style="background: #fff"
          />
        </div>
      </div>
    </div>
    <div class="container my-4" id="login-container">
      <div class="fullscreen-card">
        <h2 class="mb-4 text-center">تسجيل الدخول</h2>
        <form id="login-form" class="mb-3">
          <div class="mb-3 input-group">
            <span class="input-group-text"><i class="bi bi-person"></i></span>
            <input
              type="text"
              class="form-control"
              id="username"
              placeholder="اسم المستخدم"
              required
            />
          </div>
          <div class="mb-3 input-group">
            <span class="input-group-text"><i class="bi bi-key"></i></span>
            <input
              type="password"
              class="form-control"
              id="password"
              placeholder="كلمة السر"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary w-100">دخول</button>
          <div
            id="login-error"
            class="alert alert-danger mt-2 py-1 px-2"
            style="display: none; font-size: 1rem"
          >
            بيانات الدخول خاطئة
          </div>
        </form>
      </div>
    </div>
    <div class="container my-4" id="admin-container" style="display: none">
      <div class="fullscreen-card">
        <div class="mb-2 text-end d-block d-md-none">
          <button
            id="logout-btn-mobile"
            class="btn btn-danger"
            style="font-size: 1rem"
          >
            <i class="bi bi-box-arrow-right"></i> خروج
          </button>
        </div>
        <h2 class="mb-4 text-center">إدارة المنتجات</h2>
        <form id="product-form" class="mb-3">
          <div class="mb-3">
            <label for="productCategory" class="form-label">الصنف</label>
            <select class="form-select" id="productCategory" required>
              <option value=""></option>
              <option value="الشرقي">الشرقي</option>
              <option value="الغربي">الغربي</option>
              <option value="تورتات">تورتات</option>
              <option value="عصائر">عصائر</option>
              <option value="شكلاطة">شكلاطة</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="productName" class="form-label">اسم المنتج</label>
            <input type="text" class="form-control" id="productName" required />
          </div>
          <div class="mb-3">
            <label for="productDesc" class="form-label">وصف المنتج</label>
            <textarea class="form-control" id="productDesc" rows="2"></textarea>
          </div>
          <div class="row">
            <div class="col-12 col-sm-6 mb-3">
              <label for="productPriceRegular" class="form-label"
                >سعر عادي</label
              >
              <input
                type="number"
                class="form-control"
                id="productPriceRegular"
                min="0"
                step="0.01"
              />
            </div>
            <div class="col-12 col-sm-6 mb-3">
              <label for="productPriceBulk" class="form-label">سعر جملة</label>
              <input
                type="number"
                class="form-control"
                id="productPriceBulk"
                min="0"
                step="0.01"
              />
            </div>
          </div>
          <div class="mb-3">
            <label for="productImgUpload" class="form-label">صورة المنتج</label>
            <div id="drop-area">
              اسحب الصورة هنا أو اضغط للرفع
              <input
                type="file"
                id="productImgUpload"
                hidden
                accept="image/*"
              />
              <img id="preview-img" />
            </div>
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-fill">
              إضافة المنتج
            </button>
            <button
              type="button"
              class="btn btn-secondary flex-fill"
              id="cancelEditBtn"
              style="display: none"
            >
              إلغاء التعديل
            </button>
          </div>
        </form>
        <input
          id="admin-search"
          class="form-control search-box"
          placeholder="ابحث عن منتج..."
          oninput="filterAdminProducts()"
        />
        <div
          id="product-list"
          class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3 mt-2 fade-in"
        ></div>
        <div
          id="admin-error"
          class="alert alert-danger mt-2 py-1 px-2"
          style="display: none"
        ></div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function showToast(msg, type = "primary") {
        const toastBody = document.getElementById("toast-body");
        const toastElem = document.getElementById("main-toast");
        toastBody.innerText = msg;
        toastElem.className =
          "toast align-items-center text-bg-" + type + " border-0";
        const toast = new bootstrap.Toast(toastElem);
        toast.show();
      }
      function zoomImg(src) {
        document.getElementById("img-modal-img").src = src;
        new bootstrap.Modal(document.getElementById("img-modal")).show();
      }
      const dropArea = document.getElementById("drop-area");
      const imgInput = document.getElementById("productImgUpload");
      let uploadedImgDataUrl = "";
      dropArea.onclick = () => imgInput.click();
      dropArea.ondragover = (e) => {
        e.preventDefault();
        dropArea.classList.add("dragover");
      };
      dropArea.ondragleave = (e) => {
        dropArea.classList.remove("dragover");
      };
      dropArea.ondrop = (e) => {
        e.preventDefault();
        dropArea.classList.remove("dragover");
        const file = e.dataTransfer.files[0];
        handleImg(file);
      };
      imgInput.onchange = (e) => handleImg(e.target.files[0]);
      function handleImg(file) {
        if (!file) return;
        let reader = new FileReader();
        reader.onload = (e) => {
          uploadedImgDataUrl = e.target.result;
          document.getElementById("preview-img").src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
      function fadeInContent(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.remove("fade-in");
        void el.offsetWidth;
        el.classList.add("fade-in");
      }
      let products = [];
      let editProductId = null;
      function showSpinner(show) {
        document.getElementById("loading-spinner").style.display = show
          ? "block"
          : "none";
      }
      async function fetchProducts(category = null) {
        showSpinner(true);
        try {
          let url = "/api/products";
          if (category) url += "?category=" + encodeURIComponent(category);
          const res = await fetch(url);
          products = res.ok ? await res.json() : [];
        } catch (e) {
          document.getElementById("admin-error").textContent =
            "خطأ في تحميل المنتجات.";
          document.getElementById("admin-error").style.display = "";
          products = [];
          showToast("خطأ أثناء تحميل المنتجات", "danger");
        }
        renderProducts();
        showSpinner(false);
      }
      function renderProducts() {
        const productList = document.getElementById("product-list");
        productList.innerHTML = "";
        products.forEach((product) => {
          const price_regular =
            product.price_regular !== undefined &&
            product.price_regular !== null &&
            product.price_regular !== ""
              ? product.price_regular + " د.ل"
              : product.price !== undefined &&
                product.price !== null &&
                product.price !== ""
              ? product.price + " د.ل"
              : "";
          const price_bulk =
            product.price_bulk !== undefined &&
            product.price_bulk !== null &&
            product.price_bulk !== ""
              ? product.price_bulk + " د.ل"
              : "";
          const card = document.createElement("div");
          card.className = "col";
          card.innerHTML = `
          <div class="product-card shadow-sm d-flex flex-column">
            <img src="${product.img}" class="card-img-top" alt="${
            product.name
          }" onclick="zoomImg('${product.img}')">
            <div class="card-body p-2 d-flex flex-column">
              <h6 class="card-title mb-1">${product.name}</h6>
              <p class="card-text" style="font-size:0.97rem;">${
                product.desc || ""
              }</p>
              <div class="mt-auto price-row">
                <span class="price-regular">${price_regular}</span>
                <span class="price-bulk">${price_bulk}</span>
              </div>
              <div class="card-btn-row mt-2">
                <button class="btn btn-danger btn-sm flex-fill" onclick="deleteProduct('${
                  product._id
                }')"><i class="bi bi-trash"></i> حذف</button>
                <button class="btn btn-warning btn-sm flex-fill" onclick="startEditProduct('${
                  product._id
                }')"><i class="bi bi-pencil-square"></i> تعديل</button>
              </div>
            </div>
          </div>
        `;
          productList.appendChild(card);
        });
        fadeInContent("product-list");
      }
      window.deleteProduct = async function (id) {
        if (!confirm("هل تريد حذف المنتج؟")) return;
        showSpinner(true);
        const res = await fetch("/api/products/" + id, { method: "DELETE" });
        if (res.ok) {
          products = products.filter((p) => p._id !== id);
          renderProducts();
          showToast("تم حذف المنتج", "success");
        } else {
          showToast("خطأ أثناء الحذف", "danger");
        }
        showSpinner(false);
      };
      window.startEditProduct = function (id) {
        const product = products.find((p) => p._id === id);
        if (!product) return;
        editProductId = id;
        document.getElementById("productName").value = product.name;
        document.getElementById("productDesc").value = product.desc;
        document.getElementById("productPriceRegular").value =
          product.price_regular !== undefined &&
          product.price_regular !== null &&
          product.price_regular !== ""
            ? product.price_regular
            : product.price !== undefined &&
              product.price !== null &&
              product.price !== ""
            ? product.price
            : "";
        document.getElementById("productPriceBulk").value =
          product.price_bulk !== undefined &&
          product.price_bulk !== null &&
          product.price_bulk !== ""
            ? product.price_bulk
            : "";
        document.getElementById("productCategory").value = product.category;
        uploadedImgDataUrl = product.img;
        document.getElementById("preview-img").src = product.img;
        document.getElementById("cancelEditBtn").style.display = "";
        window.scrollTo({ top: 0, behavior: "smooth" });
      };
      document
        .getElementById("cancelEditBtn")
        .addEventListener("click", function () {
          editProductId = null;
          document.getElementById("product-form").reset();
          uploadedImgDataUrl = "";
          document.getElementById("preview-img").src = "";
          this.style.display = "none";
        });
      document
        .getElementById("productCategory")
        .addEventListener("change", function () {
          fetchProducts(this.value);
        });
      document
        .getElementById("product-form")
        .addEventListener("submit", async function (event) {
          event.preventDefault();
          const category = document.getElementById("productCategory").value;
          const name = document.getElementById("productName").value;
          const desc = document.getElementById("productDesc").value;
          const price_regular = document.getElementById(
            "productPriceRegular"
          ).value;
          const price_bulk = document.getElementById("productPriceBulk").value;
          const img = uploadedImgDataUrl;
          if (
            !category ||
            !name ||
            !img ||
            (price_regular === "" && price_bulk === "")
          ) {
            showToast("يرجى تعبئة جميع الحقول المطلوبة.", "warning");
            return;
          }
          const productData = {
            name,
            category,
            desc,
            img,
            price_regular: price_regular !== "" ? price_regular : undefined,
            price_bulk: price_bulk !== "" ? price_bulk : undefined,
          };
          showSpinner(true);
          if (editProductId) {
            const res = await fetch("/api/products/" + editProductId, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(productData),
            });
            if (res.ok) {
              const i = products.findIndex((p) => p._id === editProductId);
              if (i >= 0) products[i] = { ...productData, _id: editProductId };
              renderProducts();
              editProductId = null;
              document.getElementById("cancelEditBtn").style.display = "none";
              this.reset();
              uploadedImgDataUrl = "";
              document.getElementById("preview-img").src = "";
              showToast("تم تعديل المنتج", "success");
            } else {
              showToast("خطأ أثناء تعديل المنتج", "danger");
            }
          } else {
            const res = await fetch("/api/products", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(productData),
            });
            if (res.ok) {
              fetchProducts(category);
              this.reset();
              uploadedImgDataUrl = "";
              document.getElementById("preview-img").src = "";
              showToast("تمت إضافة المنتج", "success");
            } else {
              showToast("خطأ أثناء إضافة المنتج", "danger");
            }
          }
          showSpinner(false);
        });
      document
        .getElementById("login-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const username = document.getElementById("username").value;
          const password = document.getElementById("password").value;
          showSpinner(true);
          const res = await fetch("/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          showSpinner(false);
          if (res.ok) {
            document.getElementById("login-container").style.display = "none";
            document.getElementById("admin-container").style.display = "";
            fetchProducts();
            showToast("تم تسجيل الدخول", "success");
          } else {
            document.getElementById("login-error").style.display = "";
            showToast("بيانات الدخول غير صحيحة", "danger");
          }
        });
      async function checkAuth() {
        const res = await fetch("/api/admin-check");
        if (res.ok) {
          document.getElementById("login-container").style.display = "none";
          document.getElementById("admin-container").style.display = "";
          fetchProducts();
        } else {
          document.getElementById("login-container").style.display = "";
          document.getElementById("admin-container").style.display = "none";
        }
      }
      async function logout() {
        document.cookie =
          "admin=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        document.getElementById("login-container").style.display = "";
        document.getElementById("admin-container").style.display = "none";
        showToast("تم تسجيل الخروج", "info");
      }
      document.getElementById("logout-btn").addEventListener("click", logout);
      document
        .getElementById("logout-btn-mobile")
        .addEventListener("click", logout);
      window.filterAdminProducts = function () {
        const q = document.getElementById("admin-search").value.trim();
        let found = false;
        document
          .querySelectorAll("#product-list .product-card")
          .forEach((card) => {
            const visible = card.innerText.includes(q);
            card.parentElement.style.display = visible ? "" : "none";
            if (visible) found = true;
          });
        if (!found) showToast("لا يوجد نتائج مطابقة", "warning");
      };
      window.zoomImg = zoomImg;
      checkAuth();
    </script>
  </body>
</html>
