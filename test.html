<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Testing Dashboard - eMenu</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css">
    <style>
        body {
            background: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            text-align: right;
        }
        .header {
            background: linear-gradient(135deg, #fdb518 0%, #ffc849 100%);
            color: #fff;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 8px;
        }
        .test-section {
            background: #fff;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-button {
            margin: 0.5rem;
            min-width: 150px;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .loading {
            color: #007bff;
            font-weight: bold;
        }
        .response-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.9rem;
            direction: ltr;
            text-align: left;
            font-family: 'Courier New', monospace;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 0.5rem;
        }
        .status-ok {
            background: #28a745;
        }
        .status-error {
            background: #dc3545;
        }
        .status-pending {
            background: #ffc107;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        table th, table td {
            border: 1px solid #dee2e6;
            padding: 0.75rem;
            text-align: right;
        }
        table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .btn-group-test {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="header">
            <h1>ğŸ§ª API Testing Dashboard</h1>
            <p>Ø§Ø®ØªØ¨Ø± API ÙˆØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
        </div>

        <!-- Server Health Check -->
        <div class="test-section">
            <h3>1ï¸âƒ£ ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ø®Ø§Ø¯Ù…</h3>
            <button class="btn btn-primary test-button" onclick="testHealth()">
                Ø§Ø®ØªØ¨Ø± Ø§Ù„Ø§ØªØµØ§Ù„
            </button>
            <span id="health-status"></span>
            <div id="health-response" class="response-box"></div>
        </div>

        <!-- Categories Test -->
        <div class="test-section">
            <h3>2ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØ¦Ø§Øª (Categories)</h3>
            <button class="btn btn-info test-button" onclick="testCategories()">
                Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙØ¦Ø§Øª
            </button>
            <span id="categories-status"></span>
            <div id="categories-response" class="response-box"></div>
            <div id="categories-table"></div>
        </div>

        <!-- Products Test -->
        <div class="test-section">
            <h3>3ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Products)</h3>
            <div class="btn-group-test">
                <button class="btn btn-success test-button" onclick="testAllProducts()">
                    Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                </button>
                <button class="btn btn-success test-button" onclick="testProductsByCategory('Ø§Ù„ØºØ±Ø¨ÙŠ')">
                    Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØºØ±Ø¨ÙŠ
                </button>
                <button class="btn btn-success test-button" onclick="testProductsByCategory('Ø§Ù„Ø´Ø±Ù‚ÙŠ')">
                    Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø´Ø±Ù‚ÙŠ
                </button>
            </div>
            <span id="products-status"></span>
            <div id="products-response" class="response-box"></div>
            <div id="products-table"></div>
        </div>

        <!-- Detailed Product Info -->
        <div class="test-section">
            <h3>4ï¸âƒ£ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙØµÙŠÙ„ÙŠØ©</h3>
            <div id="detailed-info"></div>
        </div>

        <!-- Network Log -->
        <div class="test-section">
            <h3>ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
            <button class="btn btn-secondary test-button" onclick="clearLog()">
                Ø§Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
            </button>
            <div id="network-log" class="response-box" style="max-height: 300px;"></div>
        </div>
    </div>

    <script>
        let networkLog = [];

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            networkLog.push({ timestamp, message, type });
            updateNetworkLog();
        }

        function updateNetworkLog() {
            const logDiv = document.getElementById('network-log');
            logDiv.innerHTML = networkLog.map(log => {
                const color = log.type === 'error' ? '#dc3545' : log.type === 'success' ? '#28a745' : '#007bff';
                return `<div style="color: ${color}; margin-bottom: 0.5rem;">
                    [${log.timestamp}] ${log.message}
                </div>`;
            }).join('');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            networkLog = [];
            updateNetworkLog();
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            if (status === 'loading') {
                element.innerHTML = `<span class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span> <span class="status-indicator status-pending"></span>`;
            } else if (status === 'success') {
                element.innerHTML = `<span class="success">âœ“ Ù†Ø¬Ø­</span> <span class="status-indicator status-ok"></span>`;
            } else {
                element.innerHTML = `<span class="error">âœ— Ø®Ø·Ø£: ${message}</span> <span class="status-indicator status-error"></span>`;
            }
        }

        async function testHealth() {
            updateStatus('health-status', 'loading');
            addLog('Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± ØµØ­Ø© Ø§Ù„Ø®Ø§Ø¯Ù…...');
            const url = '/api/health';
            addLog(`Ø·Ù„Ø¨: GET ${url}`);
            
            try {
                const response = await fetch(url);
                addLog(`Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${response.status} ${response.statusText}`);
                
                const text = await response.text();
                addLog(`Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ø§Ù…: ${text.substring(0, 100)}`);
                
                const data = JSON.parse(text);
                
                document.getElementById('health-response').innerHTML = JSON.stringify(data, null, 2);
                updateStatus('health-status', 'success');
                addLog('âœ“ Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ³ØªØ¬ÙŠØ¨ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'success');
            } catch (error) {
                document.getElementById('health-response').innerHTML = `<span class="error">Ø®Ø·Ø£: ${error.message}</span>`;
                updateStatus('health-status', 'error', error.message);
                addLog(`âœ— Ø®Ø·Ø£: ${error.message}`, 'error');
            }
        }

        async function testCategories() {
            updateStatus('categories-status', 'loading');
            addLog('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙØ¦Ø§Øª...');
            
            try {
                const response = await fetch('/api/categories');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const categories = await response.json();
                
                document.getElementById('categories-response').innerHTML = JSON.stringify(categories, null, 2);
                updateStatus('categories-status', 'success');
                addLog(`âœ“ ØªÙ… Ø¬Ù„Ø¨ ${categories.length} ÙØ¦Ø§Øª Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                
                // Display table
                displayCategoriesTable(categories);
            } catch (error) {
                document.getElementById('categories-response').innerHTML = `<span class="error">Ø®Ø·Ø£: ${error.message}</span>`;
                updateStatus('categories-status', 'error', error.message);
                addLog(`âœ— Ø®Ø·Ø£: ${error.message}`, 'error');
            }
        }

        function displayCategoriesTable(categories) {
            if (!categories || categories.length === 0) return;
            
            let html = '<table><thead><tr><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„Ø±Ù…Ø²</th><th>Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©</th></tr></thead><tbody>';
            
            categories.forEach(cat => {
                html += `<tr>
                    <td>${cat.name}</td>
                    <td>${cat.emoji}</td>
                    <td>${(cat.subCategories || []).join(', ')}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('categories-table').innerHTML = html;
        }

        async function testAllProducts() {
            updateStatus('products-status', 'loading');
            addLog('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...');
            
            try {
                const response = await fetch('/api/products');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const products = await response.json();
                
                document.getElementById('products-response').innerHTML = JSON.stringify(products.slice(0, 3), null, 2) + 
                    `\n... Ùˆ ${products.length - 3} Ù…Ù†ØªØ¬ Ø¢Ø®Ø±`;
                updateStatus('products-status', 'success');
                addLog(`âœ“ ØªÙ… Ø¬Ù„Ø¨ ${products.length} Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                
                displayProductsTable(products);
                displayDetailedInfo(products);
            } catch (error) {
                document.getElementById('products-response').innerHTML = `<span class="error">Ø®Ø·Ø£: ${error.message}</span>`;
                updateStatus('products-status', 'error', error.message);
                addLog(`âœ— Ø®Ø·Ø£: ${error.message}`, 'error');
            }
        }

        async function testProductsByCategory(category) {
            updateStatus('products-status', 'loading');
            addLog(`Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ù…Ù†ØªØ¬Ø§Øª "${category}"...`);
            
            try {
                const response = await fetch(`/api/products?category=${encodeURIComponent(category)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const products = await response.json();
                
                document.getElementById('products-response').innerHTML = JSON.stringify(products.slice(0, 3), null, 2) + 
                    `\n... Ùˆ ${products.length - 3} Ù…Ù†ØªØ¬ Ø¢Ø®Ø±`;
                updateStatus('products-status', 'success');
                addLog(`âœ“ ØªÙ… Ø¬Ù„Ø¨ ${products.length} Ù…Ù†ØªØ¬ Ù…Ù† ÙØ¦Ø© "${category}"`, 'success');
                
                displayProductsTable(products);
                displayDetailedInfo(products);
            } catch (error) {
                document.getElementById('products-response').innerHTML = `<span class="error">Ø®Ø·Ø£: ${error.message}</span>`;
                updateStatus('products-status', 'error', error.message);
                addLog(`âœ— Ø®Ø·Ø£: ${error.message}`, 'error');
            }
        }

        function displayProductsTable(products) {
            if (!products || products.length === 0) return;
            
            let html = '<table><thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ÙˆØµÙ</th></tr></thead><tbody>';
            
            products.slice(0, 10).forEach(product => {
                html += `<tr>
                    <td>${product.name || 'N/A'}</td>
                    <td>${product.category || 'N/A'}</td>
                    <td>${product.price || product.price_regular || 'N/A'}</td>
                    <td>${(product.desc || '').substring(0, 30)}...</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            if (products.length > 10) {
                html += `<p style="margin-top: 1rem; font-weight: bold;">ÙˆØ£ÙƒØ«Ø± Ù…Ù† ${products.length - 10} Ù…Ù†ØªØ¬ Ø¢Ø®Ø±</p>`;
            }
            document.getElementById('products-table').innerHTML = html;
        }

        function displayDetailedInfo(products) {
            if (!products || products.length === 0) return;
            
            let html = '<div style="direction: ltr; text-align: left;"><pre style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">';
            
            const stats = {
                'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª': products.length,
                'Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©': new Set(products.map(p => p.category)).size,
                'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø³Ø¹Ø± Ù…Ù†ØªØ¸Ù…': products.filter(p => p.price_regular).length,
                'Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ù…Ù„Ø©': products.filter(p => p.price_bulk).length,
                'Ù…Ù†ØªØ¬Ø§Øª Ø¨ØµÙˆØ±': products.filter(p => p.image).length,
            };
            
            html += Object.entries(stats).map(([key, value]) => `${key}: ${value}`).join('\n');
            html += '</pre></div>';
            
            document.getElementById('detailed-info').innerHTML = html;
        }

        // Auto-test on load
        window.addEventListener('load', () => {
            addLog('ØªÙ… ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
            addLog('Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø§Ø®ØªØ¨Ø§Ø± API');
        });
    </script>
</body>
</html>
